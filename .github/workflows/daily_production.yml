name: Daily Shorts Production

on:
  schedule:
    # 18:00 Asia/Seoul = 09:00 UTC
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  produce:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-noto-cjk

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run batch generation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_TTS_MODEL: ${{ secrets.OPENAI_TTS_MODEL }}
          OPENAI_TTS_VOICE: ${{ secrets.OPENAI_TTS_VOICE }}
          OPENAI_TTS_VOICES: ${{ secrets.OPENAI_TTS_VOICES }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ADMIN_CHAT_ID: ${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}
          TELEGRAM_DEBUG_LOGS: "1"
          YOUTUBE_UPLOAD_ENABLED: ${{ secrets.YOUTUBE_UPLOAD_ENABLED }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          YOUTUBE_PRIVACY_STATUS: ${{ secrets.YOUTUBE_PRIVACY_STATUS }}
          FONT_PATH: /usr/share/fonts/truetype/noto/NotoSansCJK-Regular.ttc
          OUTPUT_DIR: /tmp/auto_shorts_output
          REQUIRE_APPROVAL: "0"
          AUTO_RUN_DAILY: "0"
          ASSET_OVERLAY_MODE: "off"
          MAX_VIDEO_DURATION_SEC: "59"
          RUN_BATCH: "1"
          BATCH_COUNT: "1"
          BATCH_SEED: "Pepsi Challenge Scam"
          PYTHONPYCACHEPREFIX: /tmp/pycache
        run: |
          python qq.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shorts-output
          path: /tmp/auto_shorts_output
